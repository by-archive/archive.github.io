<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Universal Archive</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <style>
        :root { --bg: #ffffff; --card: #f5f5f7; --text: #1d1d1f; --sub: #86868b; --accent: #0071e3; --admin: #efeff4; }
        [data-theme="dark"] { --bg: #000000; --card: #1c1c1e; --text: #f5f5f7; --sub: #a1a1a6; --admin: #2c2c2e; }
        
        body { font-family: 'Pretendard', sans-serif; background: var(--bg); color: var(--text); margin: 0; transition: 0.3s; padding-bottom: 80px; overflow-x: hidden; }
        
        header { max-width: 1100px; margin: 0 auto; padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        
        .top-btn { background: none; border: none; padding: 6px 10px; cursor: pointer; color: var(--text); font-size: 13px; font-weight: 300; transition: 0.2s; opacity: 0.7; }
        .top-btn:hover { opacity: 1; }
        .top-btn.active { font-weight: 600; opacity: 1; }
        .top-btn.add-btn { background: var(--accent); color: white; border-radius: 8px; font-weight: 400; opacity: 1; }
        
        #searchWrapper { display: none; margin-bottom: 20px; }
        .search-input { width: 100%; padding: 12px 20px; border-radius: 15px; border: 1px solid var(--admin); background: var(--card); color: var(--text); font-size: 15px; box-sizing: border-box; outline: none; }
        
        .tabs-container { display: flex; align-items: center; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid var(--card); }
        .main-tabs { display: flex; gap: 18px; padding-bottom: 10px; overflow-x: auto; scrollbar-width: none; flex: 1; }
        .tab-item { font-size: 16px; font-weight: 600; cursor: pointer; color: var(--sub); transition: 0.2s; position: relative; white-space: nowrap; }
        .tab-item.active { color: var(--accent); }
        .tab-item.active::after { content: ''; position: absolute; bottom: -12px; left: 0; width: 100%; height: 3px; background: var(--accent); border-radius: 10px; }
        .tab-edit-btn { padding: 5px 10px 15px; cursor: pointer; color: var(--sub); font-size: 18px; border: none; background: none; }
        
        #editControls { display: none; background: var(--admin); color: var(--text); padding: 15px 20px; border-radius: 15px; margin-bottom: 20px; justify-content: space-between; align-items: center; position: sticky; top: 10px; z-index: 10; }
        
        .sub-bar-container { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
        .sub-bar { display: flex; gap: 10px; overflow-x: auto; scrollbar-width: none; }
        .filter-btn { background: var(--card); border: none; padding: 8px 16px; border-radius: 15px; cursor: pointer; color: var(--text); font-size: 14px; white-space: nowrap; }
        .filter-btn.active { background: var(--accent); color: white; }
        
        .grid { display: grid; gap: 15px; }
        .card { background: var(--card); border-radius: 20px; overflow: hidden; cursor: pointer; transition: 0.2s; border: 2px solid transparent; position: relative; display: flex; flex-direction: column; }
        .card.selected { border-color: var(--accent); opacity: 0.6; transform: scale(0.98); }
        .card-img { width: 100%; object-fit: cover; display: block; background: #eee; }
        
        .view-simple { grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); }
        .view-simple .card-img { height: 180px; }
        
        .view-detail .card { flex-direction: row; padding: 10px 15px; align-items: center; } 
        .view-detail .card-img { width: 90px; height: 90px; border-radius: 12px; margin-right: 15px; flex-shrink: 0; }
        
        .card-info { padding: 15px; flex: 1; overflow: hidden; }
        .card-type-tag { font-size: 10px; color: var(--accent); font-weight: 800; margin-bottom: 4px; display: block; }
        .card-desc { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 13px; color: var(--sub); margin-top: 5px; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(8px); }
        .modal-content { background: var(--bg); width: 90%; max-width: 450px; border-radius: 25px; max-height: 85vh; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        .modal-body { padding: 25px; overflow-y: auto; flex: 1; }
        
        input, textarea, select { width: 100%; padding: 12px; margin: 8px 0; border-radius: 12px; border: none; background: var(--card); color: var(--text); font-family: inherit; box-sizing: border-box; outline: none; }
        textarea { resize: vertical; min-height: 60px; }

        .btn-main { width: 100%; padding: 14px; border-radius: 12px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px; }
        .btn-sm { background: var(--card); border: none; padding: 8px 14px; border-radius: 12px; cursor: pointer; color: var(--text); font-size: 13px; font-weight: 600; }
        
        .slider-container { position: relative; width: 100%; height: 280px; background: var(--card); border-radius: 15px; overflow: hidden; margin-bottom: 10px; }
        .slider-wrapper { display: flex; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); height: 100%; }
        .slider-item { min-width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .slider-item img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .slider-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: white; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; z-index: 2; }
        
        .thumb-list { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none; }
        .thumb-item { width: 50px; height: 50px; border-radius: 8px; object-fit: cover; cursor: pointer; opacity: 0.5; border: 2px solid transparent; transition: 0.2s; flex-shrink: 0; }
        .thumb-item.active { opacity: 1; border-color: var(--accent); }
        
        details.bot-settings { background: var(--admin); border-radius: 12px; padding: 5px 12px; margin: 8px 0; }
        details.bot-settings summary { font-size: 13px; font-weight: 600; cursor: pointer; padding: 8px 0; color: var(--sub); outline: none; list-style: none; display: flex; justify-content: space-between; align-items: center; }
        details.bot-settings summary::after { content: 'â–¼'; font-size: 10px; transition: 0.2s; }
        details[open].bot-settings summary::after { transform: rotate(180deg); }

        .file-slot { background: var(--card); border-radius: 10px; padding: 10px 15px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px; cursor: pointer; transition: 0.2s; border: 1px solid transparent; }
        .file-slot:hover { border-color: var(--accent); background: var(--admin); }
        .file-slot .dl-icon { color: var(--sub); opacity: 0.5; }
        .file-edit-item { display: flex; align-items: center; gap: 5px; background: var(--admin); padding: 5px 10px; border-radius: 8px; margin-bottom: 5px; font-size: 12px; }
    </style>
</head>
<body data-theme="light">

<header>
    <h1 style="margin:0; font-size: 20px;">Archive</h1>
    <div id="topControls" style="display:flex; gap:5px;"></div>
</header>

<div class="container">
    <div id="searchWrapper"><input type="text" id="searchInput" class="search-input" placeholder="ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." oninput="render()"></div>
    
    <div class="tabs-container">
        <div class="main-tabs" id="mainTabs"></div>
        <button class="tab-edit-btn" title="ì¹´í…Œê³ ë¦¬ í¸ì§‘" onclick="openCategoryModal()">+</button>
    </div>

    <div id="editControls">
        <span id="selectedCount">0ê°œ ì„ íƒë¨</span>
        <div style="display:flex; gap:8px;">
            <button class="btn-sm" style="background:var(--accent); color:white;" onclick="openMoveModal()">ì´ë™</button>
            <button class="btn-sm" style="background:#ff3b30; color:white;" onclick="deleteSelected()">ì‚­ì œ</button>
            <button class="btn-sm" style="background:var(--sub); color:white;" onclick="toggleEditMode()">ì™„ë£Œ</button>
        </div>
    </div>

    <div class="sub-bar-container">
        <div class="sub-bar" id="subFilters"></div>
        <button id="manageBtn" class="btn-sm" onclick="toggleEditMode()">âš™ï¸ í¸ì§‘</button>
    </div>

    <div id="archiveList" class="grid"></div>
</div>

<div id="categoryModal" class="modal"><div class="modal-content"><div class="modal-body" id="catContent"></div></div></div>
<div id="moveModal" class="modal"><div class="modal-content"><div class="modal-body" id="moveContent"></div></div></div>
<div id="editModal" class="modal"><div class="modal-content"><div class="modal-body" id="editForm"></div></div></div>
<div id="viewModal" class="modal"><div class="modal-content"><div class="modal-body" id="viewDetail"></div></div></div>

<script>
    let db;
    const dbName = "ArchiveDB";
    const request = indexedDB.open(dbName, 1);
    request.onupgradeneeded = (e) => {
        db = e.target.result;
        if (!db.objectStoreNames.contains("posts")) db.createObjectStore("posts", { keyPath: "id", autoIncrement: true });
    };
    request.onsuccess = (e) => {
        db = e.target.result;
        loadData();
    };

    let categories = JSON.parse(localStorage.getItem('archiveCategories')) || ['AI Bots', 'Prompts', 'Images', 'Notes'];
    let data = [];
    let currentMainType = 'ì „ì²´'; 
    let currentSubFilter = 'ì „ì²´';
    let selectedIndices = []; 
    let isEditMode = false;
    let viewMode = 'simple';
    let currentSlide = 0;
    let tempEditFiles = [];

    function loadData() {
        const tx = db.transaction(["posts"], "readonly");
        const store = tx.objectStore("posts");
        const req = store.getAll();
        req.onsuccess = () => {
            data = req.result;
            render();
        };
    }

    function render() {
        const searchQuery = document.getElementById('searchInput').value.toLowerCase();
        
        document.getElementById('topControls').innerHTML = `
            <button class="top-btn" onclick="toggleSearch()">Search</button>
            <button class="top-btn ${viewMode === 'simple' ? 'active' : ''}" onclick="setView('simple')">Simple</button>
            <button class="top-btn ${viewMode === 'detail' ? 'active' : ''}" onclick="setView('detail')">Detail</button>
            <button class="top-btn" onclick="toggleTheme()">Theme</button>
            <button class="top-btn add-btn" onclick="openAddModal()">Add Post</button>
        `;

        const displayCats = ['ì „ì²´', ...categories];
        document.getElementById('mainTabs').innerHTML = displayCats.map(cat => `
            <div class="tab-item ${currentMainType === cat ? 'active' : ''}" onclick="setMainType('${cat}')">${cat}</div>
        `).join('');

        const list = document.getElementById('archiveList');
        list.className = `grid view-${viewMode}`;
        list.innerHTML = '';

        const filteredData = data.filter(item => 
            (currentMainType === 'ì „ì²´' || item.mainType === currentMainType) && 
            (item.title.toLowerCase().includes(searchQuery) || item.content.toLowerCase().includes(searchQuery))
        );

        const targetSubData = currentMainType === 'ì „ì²´' ? data : data.filter(i => i.mainType === currentMainType);
        const subCats = ['ì „ì²´', ...new Set(targetSubData.map(i => i.subCat))];
        document.getElementById('subFilters').innerHTML = subCats.map(s => `
            <button class="filter-btn ${currentSubFilter === s ? 'active' : ''}" onclick="setSubFilter('${s}')">${s}</button>
        `).join('');

        filteredData.forEach((item) => {
            if (currentSubFilter !== 'ì „ì²´' && item.subCat !== currentSubFilter) return;
            
            const files = item.files || [];
            const firstImg = files.find(f => f.type.includes('image'));
            const card = document.createElement('div');
            card.className = `card ${selectedIndices.includes(item.id) ? 'selected' : ''}`;
            card.onclick = () => isEditMode ? toggleSelect(item.id) : showDetail(item.id);
            
            const tagLabel = currentMainType === 'ì „ì²´' ? `${item.mainType} > ${item.subCat}` : item.subCat;
            
            card.innerHTML = `
                ${firstImg ? `<img src="${firstImg.data}" class="card-img">` : ''}
                <div class="card-info">
                    <span class="card-type-tag">${tagLabel}</span>
                    <h3 style="margin:0; font-size:15px;">${item.title}</h3>
                    ${viewMode === 'detail' ? `<div class="card-desc">${item.desc || item.content}</div>` : ''}
                </div>
            `;
            list.appendChild(card);
        });
    }

    function showDetail(id) {
        currentSlide = 0;
        const item = data.find(p => p.id === id);
        const files = item.files || [];
        const imgs = files.filter(f => f.type.includes('image'));
        
        document.getElementById('viewDetail').innerHTML = `
            ${imgs.length > 0 ? `
                <div class="slider-container">
                    <div class="slider-wrapper" id="sliderWrapper">${imgs.map(img => `<div class="slider-item"><img src="${img.data}"></div>`).join('')}</div>
                    ${imgs.length > 1 ? `<button class="slider-btn" style="left:10px;" onclick="moveSlide(-1, ${imgs.length})">ã€ˆ</button><button class="slider-btn" style="right:10px;" onclick="moveSlide(1, ${imgs.length})">ã€‰</button>` : ''}
                </div>
                <div class="thumb-list">${imgs.map((img, i) => `<img src="${img.data}" class="thumb-item ${i===0?'active':''}" onclick="goSlide(${i}, ${imgs.length})">`).join('')}</div>
            ` : ''}
            <small style="color:var(--accent)">${item.mainType} > ${item.subCat}</small>
            <h2 style="margin:5px 0">${item.title}</h2>
            ${item.desc ? `<p style="margin:0 0 10px 0; font-size:13px; color:var(--sub);">${item.desc}</p>` : ''}
            ${item.greeting ? `<div style="background:var(--admin); padding:12px; border-radius:12px; font-size:13px; margin-bottom:10px; border-left:4px solid var(--accent);"><strong>ê·¸ë¦¬íŒ…:</strong><br>${item.greeting}</div>` : ''}
            <div style="background:var(--card); padding:15px; border-radius:12px; white-space:pre-wrap; font-size:14px; margin:10px 0;">${item.content}</div>
            ${item.link ? `<a href="${item.link}" target="_blank" style="color:var(--accent); font-size:13px; text-decoration:none; display:block; margin-bottom:15px;">ğŸ”— ê´€ë ¨ ë§í¬ ë°”ë¡œê°€ê¸°</a>` : ''}
            
            <div style="margin-top:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <h4 style="margin:0; font-size:13px; color:var(--sub);">ì²¨ë¶€ íŒŒì¼ (${files.length})</h4>
                    ${files.length > 0 ? `<button onclick="downloadAll('${item.title}')" style="background:none; border:none; color:var(--accent); font-size:12px; cursor:pointer;">ì „ì²´ ë‹¤ìš´ë¡œë“œ</button>` : ''}
                </div>
                ${files.map(f => `
                    <div class="file-slot" onclick="downloadFile('${f.data}', '${f.name}')">
                        <span style="font-size:12px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; flex:1; margin-right:10px;">ğŸ“ ${f.name}</span>
                        <span class="dl-icon">â¬‡</span>
                    </div>
                `).join('')}
            </div>

            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:25px;">
                <button class="btn-main" style="margin:0; background:var(--card);" onclick="closeModal('viewModal')">ë‹«ê¸°</button>
                <button class="btn-main" style="margin:0; background:var(--text); color:var(--bg);" onclick="showEditForm(${id})">ìˆ˜ì •í•˜ê¸°</button>
            </div>
        `;
        document.getElementById('viewModal').style.display = 'flex';
    }

    async function showEditForm(id = null) {
        if(id !== null) closeModal('viewModal');
        const item = id !== null ? data.find(p => p.id === id) : { title: '', mainType: (currentMainType==='ì „ì²´'?categories[0]:currentMainType), subCat: '', content: '', desc: '', greeting: '', link: '', files: [] };
        tempEditFiles = [...(item.files || [])];
        const subs = [...new Set(data.filter(i => i.mainType === item.mainType).map(i => i.subCat))];

        const renderFileEditor = () => {
            const fl = document.getElementById('editFileList');
            if(!fl) return;
            fl.innerHTML = tempEditFiles.map((f, i) => `
                <div class="file-edit-item">
                    <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${f.type.includes('image') ? 'ğŸ–¼ï¸' : 'ğŸ“'} ${f.name}</span>
                    <button class="btn-sm" style="padding:2px 6px;" onclick="moveFile(${i},-1)">â†‘</button>
                    <button class="btn-sm" style="padding:2px 6px;" onclick="moveFile(${i},1)">â†“</button>
                    <button class="btn-sm" style="padding:2px 6px; color:red;" onclick="tempEditFiles.splice(${i},1); renderFileEditor();">âœ•</button>
                </div>
            `).join('');
        };

        document.getElementById('editForm').innerHTML = `
            <h3>ê²Œì‹œë¬¼ ì‘ì„±/ìˆ˜ì •</h3>
            <div style="display: flex; gap: 10px;">
                <div style="flex: 1;">
                    <label style="font-size:12px; color:var(--sub);">ë©”ì¸ ì¹´í…Œê³ ë¦¬</label>
                    <select id="editMainType">${categories.map(c => `<option value="${c}" ${item.mainType===c?'selected':''}>${c}</option>`).join('')}</select>
                </div>
                <div style="flex: 1;">
                    <label style="font-size:12px; color:var(--sub);">ì„œë¸Œ ì¹´í…Œê³ ë¦¬</label>
                    <input type="text" id="editSubCat" list="subList" placeholder="ì¹´í…Œê³ ë¦¬ ì…ë ¥" value="${item.subCat}">
                    <datalist id="subList">${subs.map(s => `<option value="${s}">`).join('')}</datalist>
                </div>
            </div>
            
            <input type="text" id="editTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" value="${item.title}">
            
            <details class="bot-settings">
                <summary>ë´‡ ì„¤ëª… (ë””ìŠ¤í¬ë¦½ì…˜, ê·¸ë¦¬íŒ…)</summary>
                <textarea id="editDesc" placeholder="ë´‡ ë””ìŠ¤í¬ë¦½ì…˜ (ì„ íƒì‚¬í•­)">${item.desc || ''}</textarea>
                <textarea id="editGreeting" placeholder="ë´‡ ê·¸ë¦¬íŒ… (ì„ íƒì‚¬í•­)">${item.greeting || ''}</textarea>
            </details>

            <textarea id="editContent" rows="6" placeholder="ë³¸ë¬¸ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">${item.content}</textarea>
            <input type="text" id="editLink" placeholder="ê´€ë ¨ ë§í¬ (URL)" value="${item.link}">
            
            <div style="margin-top:10px; border-top:1px solid var(--admin); padding-top:10px;">
                <label style="font-size:12px; font-weight:bold;">íŒŒì¼ ì²¨ë¶€</label>
                <input type="file" id="editFileInp" multiple style="margin-top:5px;">
                <div id="editFileList" style="margin-top:10px; max-height:150px; overflow-y:auto;"></div>
            </div>
            
            <button class="btn-main" style="background:var(--accent); color:white" onclick="saveArchiveItem(${id})">ì €ì¥í•˜ê¸°</button>
            <button class="btn-main" style="background:none" onclick="closeModal('editModal')">ì·¨ì†Œ</button>
        `;
        renderFileEditor();

        document.getElementById('editFileInp').onchange = async (e) => {
            const files = Array.from(e.target.files);
            for (const file of files) {
                const reader = new FileReader();
                const fileData = await new Promise((resolve) => {
                    reader.onload = (ev) => resolve({ name: file.name, type: file.type, data: ev.target.result });
                    reader.readAsDataURL(file);
                });
                tempEditFiles.push(fileData);
                renderFileEditor();
            }
            e.target.value = '';
        };

        window.moveFile = (idx, dir) => {
            if((idx===0 && dir===-1) || (idx===tempEditFiles.length-1 && dir===1)) return;
            const t = idx + dir;
            [tempEditFiles[idx], tempEditFiles[t]] = [tempEditFiles[t], tempEditFiles[idx]];
            renderFileEditor();
        };

        window.saveArchiveItem = (i) => {
            const newItem = {
                mainType: document.getElementById('editMainType').value,
                subCat: document.getElementById('editSubCat').value || 'ê¸°ë³¸',
                title: document.getElementById('editTitle').value || 'ì œëª© ì—†ìŒ',
                desc: document.getElementById('editDesc').value,
                greeting: document.getElementById('editGreeting').value,
                content: document.getElementById('editContent').value,
                link: document.getElementById('editLink').value,
                files: tempEditFiles
            };
            if(i !== null) newItem.id = i;

            const tx = db.transaction(["posts"], "readwrite");
            const store = tx.objectStore("posts");
            const req = i !== null ? store.put(newItem) : store.add(newItem);
            req.onsuccess = () => { loadData(); closeModal('editModal'); };
        };
        document.getElementById('editModal').style.display = 'flex';
    }

    function downloadAll(title) {
        const item = data.find(p => p.title === title);
        item.files.forEach(f => downloadFile(f.data, f.name));
    }

    function moveSlide(dir, total) { goSlide((currentSlide + dir + total) % total, total); }
    function goSlide(idx, total) { currentSlide = idx; const w = document.getElementById('sliderWrapper'); if(w) w.style.transform = `translateX(-${currentSlide * 100}%)`; document.querySelectorAll('.thumb-item').forEach((t, i) => t.classList.toggle('active', i === currentSlide)); }
    function toggleSearch() { const sw = document.getElementById('searchWrapper'); sw.style.display = sw.style.display === 'block' ? 'none' : 'block'; if(sw.style.display === 'block') document.getElementById('searchInput').focus(); }
    function openAddModal() { showEditForm(); }
    function toggleEditMode() { isEditMode = !isEditMode; document.getElementById('editControls').style.display = isEditMode ? 'flex' : 'none'; selectedIndices = []; render(); }
    function toggleSelect(id) { const pos = selectedIndices.indexOf(id); if (pos > -1) selectedIndices.splice(pos, 1); else selectedIndices.push(id); document.getElementById('selectedCount').innerText = `${selectedIndices.length}ê°œ ì„ íƒë¨`; render(); }
    
    function deleteSelected() {
        if (!confirm('ì„ íƒí•œ í•­ëª©ì„ ì‚­ì œí• ê¹Œìš”?')) return;
        const tx = db.transaction(["posts"], "readwrite");
        const store = tx.objectStore("posts");
        selectedIndices.forEach(id => store.delete(id));
        tx.oncomplete = () => { loadData(); toggleEditMode(); };
    }

    function openCategoryModal() {
        tempCategories = [...categories];
        renderCategoryFields();
        document.getElementById('categoryModal').style.display = 'flex';
    }

    function renderCategoryFields() {
        document.getElementById('catContent').innerHTML = `
            <h3>ì¹´í…Œê³ ë¦¬ ê´€ë¦¬</h3>
            <div id="catList">${tempCategories.map((cat, idx) => `
                <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px;">
                    <button onclick="moveTab(${idx}, -1)" class="btn-sm">â†‘</button>
                    <button onclick="moveTab(${idx}, 1)" class="btn-sm">â†“</button>
                    <input type="text" value="${cat}" oninput="tempCategories[${idx}]=this.value" style="margin:0; flex:1;">
                    <button onclick="tempCategories.splice(${idx},1); renderCategoryFields();" style="color:red; background:none; border:none;">âœ•</button>
                </div>
            `).join('')}</div>
            <button class="btn-main" style="background:var(--card);" onclick="tempCategories.push('ìƒˆ ì¹´í…Œê³ ë¦¬'); renderCategoryFields();">ï¼‹ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</button>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:15px;">
                <button class="btn-main" style="background:var(--card);" onclick="closeModal('categoryModal')">ì·¨ì†Œ</button>
                <button class="btn-main" style="background:var(--accent); color:white;" onclick="categories=[...tempCategories]; localStorage.setItem('archiveCategories', JSON.stringify(categories)); render(); closeModal('categoryModal');">ì €ì¥</button>
            </div>
        `;
    }
    function moveTab(idx, dir) { if((idx === 0 && dir === -1) || (idx === tempCategories.length-1 && dir === 1)) return; const t = idx + dir; [tempCategories[idx], tempCategories[t]] = [tempCategories[t], tempCategories[idx]]; renderCategoryFields(); }

    function openMoveModal() {
        document.getElementById('moveContent').innerHTML = `
            <h3>í•­ëª© ì´ë™</h3>
            <label style="font-size:12px;">ëŒ€ìƒ ì¹´í…Œê³ ë¦¬</label>
            <select id="moveMain">${categories.map(cat => `<option value="${cat}">${cat}</option>`).join('')}</select>
            <input type="text" id="moveSubIn" placeholder="ì´ë™í•  ì„œë¸Œ ì¹´í…Œê³ ë¦¬ ì…ë ¥">
            <button class="btn-main" style="background:var(--accent); color:white;" onclick="confirmMove()">í™•ì¸</button>
            <button class="btn-main" onclick="closeModal('moveModal')">ì·¨ì†Œ</button>
        `;
        document.getElementById('moveModal').style.display = 'flex';
    }

    function confirmMove() {
        const nextM = document.getElementById('moveMain').value;
        const nS = document.getElementById('moveSubIn').value || "ê¸°ë³¸";
        const tx = db.transaction(["posts"], "readwrite");
        const store = tx.objectStore("posts");
        
        selectedIndices.forEach(id => {
            const item = data.find(p => p.id === id);
            item.mainType = nextM;
            item.subCat = nS;
            store.put(item);
        });
        tx.oncomplete = () => { loadData(); toggleEditMode(); closeModal('moveModal'); };
    }

    function setMainType(t) { currentMainType = t; currentSubFilter = 'ì „ì²´'; render(); }
    function setSubFilter(s) { currentSubFilter = s; render(); }
    function setView(v) { viewMode = v; render(); }
    function downloadFile(uri, name) { const link = document.createElement('a'); link.href = uri; link.download = name; link.click(); }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'light' ? 'dark' : 'light'); }
</script>
</body>
</html>